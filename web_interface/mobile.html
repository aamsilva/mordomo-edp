<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e3c72">
    <title>Utility Assistant Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 16px;
            padding-top: env(safe-area-inset-top, 12px);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-title {
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .header-subtitle {
            font-size: 0.7rem;
            opacity: 0.8;
        }
        
        .agent-status {
            display: flex;
            gap: 6px;
        }
        
        .agent-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00d4aa;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }
        
        /* Quick Actions */
        .quick-actions {
            background: #f8f9fa;
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            flex-shrink: 0;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .quick-actions::-webkit-scrollbar {
            display: none;
        }
        
        .quick-buttons {
            display: flex;
            gap: 8px;
        }
        
        .quick-btn {
            padding: 8px 14px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #495057;
            white-space: nowrap;
            flex-shrink: 0;
            touch-action: manipulation;
        }
        
        .quick-btn:active {
            background: #2a5298;
            color: white;
            transform: scale(0.95);
        }
        
        /* Chat Area */
        .chat {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            -webkit-overflow-scrolling: touch;
            background: #fafbfc;
        }
        
        .message {
            margin-bottom: 16px;
            animation: slideIn 0.3s ease-out;
            max-width: 85%;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            margin-left: auto;
        }
        
        .bubble {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .message.user .bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.bot .bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .bubble strong {
            color: #2a5298;
        }
        
        .message.user .bubble strong {
            color: rgba(255,255,255,0.9);
        }
        
        /* Typing Indicator */
        .typing {
            display: flex;
            gap: 4px;
            padding: 16px;
        }
        
        .typing span {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .typing span:nth-child(1) { animation-delay: -0.32s; }
        .typing span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Input Area */
        .input-area {
            padding: 12px 16px;
            padding-bottom: env(safe-area-inset-bottom, 12px);
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }
        
        .input-area input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e9ecef;
            border-radius: 24px;
            font-size: 1rem;
            outline: none;
            background: #f8f9fa;
            -webkit-appearance: none;
        }
        
        .input-area input:focus {
            border-color: #2a5298;
            background: white;
        }
        
        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        
        .send-btn:active {
            transform: scale(0.9);
        }
        
        /* Agent Labels */
        .agent-label {
            font-size: 0.65rem;
            color: #6c757d;
            margin-bottom: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Welcome Card */
        .welcome-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .welcome-card h3 {
            color: #1e3c72;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }
        
        .welcome-card p {
            color: #495057;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .welcome-card ul {
            margin-top: 12px;
            padding-left: 20px;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .welcome-card li {
            margin-bottom: 6px;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div>
                <div class="header-title">Utility Assistant Pro</div>
                <div class="header-subtitle">Multi-Agente</div>
            </div>
            <div class="agent-status">
                <div class="agent-dot" title="Billing"></div>
                <div class="agent-dot" title="Support"></div>
                <div class="agent-dot" title="Grid"></div>
            </div>
        </div>
        
        <div class="quick-actions">
            <div class="quick-buttons">
                <button class="quick-btn" onclick="sendQuick('Qual Ã© o valor da minha fatura?')">ðŸ’° Fatura</button>
                <button class="quick-btn" onclick="sendQuick('Mostra-me o meu consumo')">âš¡ Consumo</button>
                <button class="quick-btn" onclick="sendQuick('Tenho uma avaria')">ðŸ”§ Avaria</button>
                <button class="quick-btn" onclick="sendQuick('Quando chega o tÃ©cnico?')">ðŸ‘· TÃ©cnico</button>
            </div>
        </div>
        
        <div class="chat" id="chat">
            <div class="welcome-card">
                <h3>ðŸ‘‹ Bem-vindo!</h3>
                <p>Sou o teu assistente multi-agente. Posso ajudar-te com:</p>
                <ul>
                    <li>ðŸ’° Consultas de faturas</li>
                    <li>âš¡ AnÃ¡lise de consumo</li>
                    <li>ðŸ”§ Suporte tÃ©cnico</li>
                    <li>ðŸ‘· Agendamento de tÃ©cnicos</li>
                </ul>
            </div>
        </div>
        
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Escreve a tua mensagem..." onkeypress="if(event.key==='Enter')sendMessage()">
            <button class="send-btn" onclick="sendMessage()">âž¤</button>
        </div>
    </div>

    <script>
        const chat = document.getElementById('chat');
        const input = document.getElementById('userInput');
        const API_URL = '/mcp';
        const CHAT_URL = '/chat';

        function sendQuick(text) {
            input.value = text;
            sendMessage();
        }

        function addMessage(text, isUser, agent) {
            const div = document.createElement('div');
            div.className = 'message ' + (isUser ? 'user' : 'bot');
            
            let html = '';
            if (!isUser && agent) {
                html += '<div class="agent-label">' + agent + '</div>';
            }
            html += '<div class="bubble">' + text + '</div>';
            div.innerHTML = html;
            
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function showTyping() {
            const div = document.createElement('div');
            div.className = 'message bot typing-indicator';
            div.id = 'typing';
            div.innerHTML = '<div class="bubble typing"><span></span><span></span><span></span></div>';
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function hideTyping() {
            const t = document.getElementById('typing');
            if (t) t.remove();
        }

        async function callAPI(tool, args) {
            if (tool === 'get_invoice' && args.invoice_number === 'latest') {
                args.invoice_number = 'INV-2026-001';
            }
            
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    id: Date.now().toString(),
                    method: 'tools/call',
                    params: {name: tool, arguments: args}
                })
            });
            
            if (!res.ok) throw new Error('API Error');
            return (await res.json()).result;
        }

        async function enhanceWithLLM(message, result, tool) {
            try {
                const res = await fetch(CHAT_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message, result, tool})
                });
                if (res.ok) {
                    const data = await res.json();
                    return data.response;
                }
            } catch (e) {
                console.log('LLM error:', e);
            }
            return null;
        }

        function detectIntent(text) {
            const t = text.toLowerCase();
            if (t.includes('fatura') || t.includes('valor') || t.includes('paguei') || t.includes('conta')) {
                return {tool: 'get_invoice', args: {invoice_number: 'latest'}, agent: 'Agente FaturaÃ§Ã£o'};
            }
            if (t.includes('consumo') || t.includes('gastei') || t.includes('kwh') || t.includes('energia')) {
                return {tool: 'get_consumption', args: {period: 'month'}, agent: 'Agente Consumo'};
            }
            return null;
        }

        function formatFallback(tool, data) {
            if (tool === 'get_invoice' && data.invoice) {
                const inv = data.invoice;
                const status = inv.status === 'paid' ? 'paga' : 'pendente';
                return 'Fatura ' + inv.number + ': â‚¬' + inv.amount + '<br>Data: ' + inv.date + '<br>Consumo: ' + inv.consumption_kwh + ' kWh<br>Estado: ' + status;
            }
            return 'Dados obtidos com sucesso.';
        }

        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;
            
            addMessage(text, true);
            input.value = '';
            showTyping();
            
            try {
                const intent = detectIntent(text);
                if (!intent) {
                    hideTyping();
                    addMessage('Posso ajudar com faturaÃ§Ã£o, consumo ou suporte tÃ©cnico. Tenta perguntar sobre a tua fatura.', false, 'Sistema');
                    return;
                }
                
                const result = await callAPI(intent.tool, intent.args);
                const enhanced = await enhanceWithLLM(text, result, intent.tool);
                
                hideTyping();
                addMessage(enhanced || formatFallback(intent.tool, result), false, intent.agent);
                
            } catch (e) {
                hideTyping();
                addMessage('NÃ£o foi possÃ­vel obter os dados. Tenta novamente.', false, 'Sistema');
            }
        }

        // Auto-focus input on load
        window.onload = () => input.focus();
    </script>
</body>
</html>